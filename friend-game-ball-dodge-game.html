<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒœãƒ¼ãƒ«é¿ã‘ã‚²ãƒ¼ãƒ </title>
    <!-- ãƒ‘ã‚¹ä¿®æ­£: åŒéšå±¤ã®style.css -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="theme-friend">
    <div class="game-container">
        <h1 class="game-title">ğŸƒ ãƒœãƒ¼ãƒ«é¿ã‘ã‚²ãƒ¼ãƒ </h1>
        
        <div class="game-canvas-wrapper">
            <canvas id="gameCanvas" class="game-canvas" width="600" height="600"></canvas>
            
            <div id="gameOver" class="game-over-overlay">
                <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼</h2>
                <div id="finalScore" style="margin: 1rem 0; font-weight:bold; font-size:1.2rem;"></div>
                <button id="restartBtn" class="game-btn btn-primary">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            </div>
        </div>

        <div class="game-stats">
            <div class="stat-box">
                <div class="stat-label">æ™‚é–“</div>
                <div class="stat-value" id="score">0.0ç§’</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">åå¿œå¹´é½¢</div>
                <div class="stat-value" id="estimatedAge">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ãƒ¬ãƒ™ãƒ«</div>
                <div class="stat-value" id="difficulty" style="color:#ef4444;">1</div>
            </div>
        </div>
        
        <p style="font-size:0.9rem; color:#6b7280; margin-bottom:1.5rem;">ãƒã‚¦ã‚¹ã¾ãŸã¯æŒ‡ã§å·¦å³ã«å‹•ã„ã¦ãƒœãƒ¼ãƒ«ã‚’é¿ã‘ã‚ˆã†ï¼</p>

        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ä¿®æ­£: friend-game-main.html -->
        <a href="friend-game-main.html" class="back-to-portal-button">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é¸æŠã¸æˆ»ã‚‹</a>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const estimatedAgeDisplay = document.getElementById('estimatedAge');
        const difficultyDisplay = document.getElementById('difficulty');
        const gameOverDiv = document.getElementById('gameOver');
        const finalScoreDisplay = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
        function resizeCanvas() {
            const containerWidth = document.querySelector('.game-container').clientWidth;
            // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†ã‚’å¼•ã
            const maxWidth = Math.min(600, containerWidth - 40);
            canvas.width = maxWidth;
            canvas.height = maxWidth; // æ­£æ–¹å½¢
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let gameRunning = false;
        let startTime;
        let currentTime = 0;
        let level = 1;
        let baseSpeed = 2; // åˆæœŸé€Ÿåº¦èª¿æ•´
        let currentSpeed = baseSpeed;

        const player = { x: canvas.width / 2, y: canvas.height - 50, radius: 15, color: '#00ff00' };
        let balls = [];
        let ballRadius = 10;
        let ballSpawnRate = 1000;
        let lastBallSpawn = 0;
        let mouseX = canvas.width / 2;

        function getEstimatedAge(ms) {
            if (ms >= 800) return '80æ­³ä»¥ä¸Š';
            if (ms >= 600) return '60ä»£';
            if (ms >= 400) return '40ä»£';
            if (ms >= 200) return '20ä»£';
            return 'ã‚¢ã‚¹ãƒªãƒ¼ãƒˆç´š';
        }

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            // ã‚¹ã‚±ãƒ¼ãƒ«è£œæ­£
            mouseX = mouseX * (canvas.width / rect.width);
        });
        
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            mouseX = e.touches[0].clientX - rect.left;
            mouseX = mouseX * (canvas.width / rect.width);
        }, {passive: false});

        canvas.addEventListener('click', () => { if (!gameRunning) startGame(); });
        restartBtn.addEventListener('click', () => { gameOverDiv.style.display = 'none'; startGame(); });

        function startGame() {
            gameRunning = true;
            startTime = Date.now();
            currentTime = 0;
            level = 1;
            balls = [];
            currentSpeed = canvas.height / 200; // ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ãŸé€Ÿåº¦
            ballSpawnRate = 1000;
            estimatedAgeDisplay.textContent = '--';
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ãƒªã‚»ãƒƒãƒˆ
            player.x = canvas.width / 2;
            player.y = canvas.height - (canvas.height / 8);
            player.radius = canvas.width / 30;
            ballRadius = canvas.width / 40;

            gameLoop();
        }

        function spawnBall() {
            balls.push({
                x: Math.random() * (canvas.width - ballRadius * 2) + ballRadius,
                y: -ballRadius,
                radius: ballRadius,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`
            });
        }

        function update() {
            currentTime = (Date.now() - startTime) / 1000;
            scoreDisplay.textContent = currentTime.toFixed(1) + 'ç§’';
            
            const newLevel = Math.floor(currentTime / 5) + 1;
            if (newLevel > level) {
                level = newLevel;
                currentSpeed += 0.5;
                ballSpawnRate = Math.max(200, 1000 - (level - 1) * 80);
                difficultyDisplay.textContent = level;
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
            player.x += (mouseX - player.x) * 0.2;
            // ç”»é¢å¤–ã«ã¯ã¿å‡ºã•ãªã„
            if(player.x < player.radius) player.x = player.radius;
            if(player.x > canvas.width - player.radius) player.x = canvas.width - player.radius;
            
            if (Date.now() - lastBallSpawn > ballSpawnRate) {
                spawnBall();
                lastBallSpawn = Date.now();
            }

            for (let i = balls.length - 1; i >= 0; i--) {
                balls[i].y += currentSpeed;
                
                const dx = player.x - balls[i].x;
                const dy = player.y - balls[i].y;
                const distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < player.radius + balls[i].radius) {
                    gameOver(); return;
                }
                if (balls[i].y - balls[i].radius > canvas.height) balls.splice(i, 1);
            }
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
            ctx.fillStyle = player.color; ctx.fill();
            
            balls.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2);
                ctx.fillStyle = b.color; ctx.fill();
            });
        }

        function gameOver() {
            gameRunning = false;
            finalScoreDisplay.innerHTML = `ç”Ÿå­˜æ™‚é–“: ${currentTime.toFixed(1)}ç§’<br>ãƒ¬ãƒ™ãƒ«: ${level}`;
            gameOverDiv.style.display = 'block';
        }

        function gameLoop() {
            if (!gameRunning) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        draw();
        ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = `${canvas.width/15}px sans-serif`;
        ctx.fillText('ã‚¿ãƒƒãƒ—ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ', canvas.width/2, canvas.height/2);
    </script>
</body>
</html>