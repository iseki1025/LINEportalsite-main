<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ”ç®¡ç† - æ¢¶æœ¬ã‚¯ãƒªãƒ‹ãƒƒã‚¯ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="components.css">
</head>

<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-left">
            <button onclick="location.href='admin-dashboard.html'" class="btn-logout" style="margin-right:1rem;">â†
                æˆ»ã‚‹</button>
            <h1>ğŸ½ï¸ ãƒ¬ã‚·ãƒ”ç®¡ç†</h1>
        </div>
        <div class="admin-header-right">
            <button id="logoutBtn" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <main class="admin-container">
        <section class="editor-section">
            <h2>æ–°è¦ãƒ¬ã‚·ãƒ”ç™»éŒ²</h2>
            <form id="recipeForm">
                <div class="form-group">
                    <label for="recipeTitle">ãƒ¬ã‚·ãƒ”åï¼ˆä¾‹ï¼šå¤é‡èœã®ã‚«ãƒ¬ãƒ¼ï¼‰</label>
                    <input type="text" id="recipeTitle" required placeholder="ãƒ¬ã‚·ãƒ”åã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="recipeFile">PDFãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ10MBä»¥ä¸‹ï¼‰</label>
                    <input type="file" id="recipeFile" accept="application/pdf" required>
                </div>
                <button type="submit" id="uploadBtn" class="btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <div id="uploadProgress" style="margin-top:1rem; display:none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="spinner" style="width:20px; height:20px; border-width:2px;"></div>
                        <progress id="uploadProgressBar" value="0" max="100"
                            style="flex-grow: 1; height: 10px;"></progress>
                        <span id="progressText" style="font-size: 0.9rem; min-width: 40px;">0%</span>
                    </div>
                    <p id="uploadStatusText" style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">å‡¦ç†ä¸­...</p>
                </div>
            </form>
        </section>

        <section class="editor-section">
            <h2>ç™»éŒ²æ¸ˆã¿ãƒ¬ã‚·ãƒ”ä¸€è¦§</h2>
            <div id="recipeList">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { requireAuth } from './js/admin/auth-guard.js';
        import { requirePermission } from './js/admin/permission-check.js';
        import { showSuccess, confirmAction, showLoading } from './js/admin/ui-helper.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { firebaseConfig } from './js/firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const user = await requireAuth();
        await requirePermission('recipes');

        const recipeForm = document.getElementById('recipeForm');
        const recipeList = document.getElementById('recipeList');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');

        async function loadRecipes() {
            showLoading(recipeList);
            try {
                const q = query(collection(db, 'recipes'), orderBy('uploadedAt', 'desc'));
                const snapshot = await getDocs(q);
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecipeList(data);
            } catch (error) {
                console.error('Load recipes error:', error);
                recipeList.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        function renderRecipeList(recipes) {
            if (recipes.length === 0) {
                recipeList.innerHTML = '<p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¬ã‚·ãƒ”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            recipeList.innerHTML = recipes.map(item => `
        <div class="user-list-item" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4>ğŸ“„ ${item.title}</h4>
            <p>ç™»éŒ²æ—¥: ${item.uploadedAt?.toDate().toLocaleString()}</p>
            <p>ã‚µã‚¤ã‚º: ${(item.fileSize / 1024 / 1024).toFixed(2)} MB</p>
          </div>
          <div class="user-actions">
            <a href="${item.storageUrl}" target="_blank" class="btn-secondary" style="text-decoration:none; padding: 0.5rem 1rem; font-size: 0.8rem;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
            <button class="btn-danger" onclick="window.deleteRecipe('${item.id}', '${item.filename}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">å‰Šé™¤</button>
          </div>
        </div>
      `).join('');
        }

        recipeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('recipeTitle').value;
            const file = document.getElementById('recipeFile').files[0];

            if (!file || file.type !== 'application/pdf') {
                alert('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                return;
            }

            uploadBtn.disabled = true;
            uploadProgress.style.display = 'block';
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('progressText');
            const statusText = document.getElementById('uploadStatusText');

            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆã®æ”¹å–„: æ—¥æœ¬èªã‚’å®‰å…¨ã«å‡¦ç†ã—ã¤ã¤æ‹¡å¼µå­ã‚’ä¿æŒ
                const extension = file.name.split('.').pop();
                const safeBaseName = file.name
                    .replace(`.${extension}`, '')
                    .replace(/[^\x00-\x7F]/g, "_")
                    .replace(/\s+/g, "_");
                const filename = `${Date.now()}-${safeBaseName}.${extension}`;
                const storageRef = ref(storage, `recipes/${filename}`);

                // Storageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Resumable)
                const uploadTask = uploadBytesResumable(storageRef, file);

                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            const rounded = Math.round(progress);
                            progressBar.value = rounded;
                            progressText.textContent = `${rounded}%`;
                            statusText.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${rounded}%)`;
                        },
                        (error) => {
                            console.error('Storage upload error:', error);
                            let message = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                            if (error.code === 'storage/unauthorized') message = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                            if (error.code === 'storage/canceled') message = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
                            reject(new Error(message));
                        },
                        () => resolve()
                    );
                });

                const storageUrl = await getDownloadURL(storageRef);

                // Firestoreã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await addDoc(collection(db, 'recipes'), {
                    title: title,
                    filename: filename,
                    storageUrl: storageUrl,
                    fileSize: file.size,
                    uploadedAt: new Date(),
                    uploadedBy: user.uid,
                    uploadedByDisplayName: user.displayName || 'ç®¡ç†è€…'
                });

                showSuccess('ãƒ¬ã‚·ãƒ”ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                recipeForm.reset();
                loadRecipes();
            } catch (error) {
                console.error('Final upload error:', error);
                alert(error.message || 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                uploadBtn.disabled = false;
                uploadProgress.style.display = 'none';
                progressBar.value = 0;
                progressText.textContent = '0%';
            }
        });

        window.deleteRecipe = async (id, filename) => {
            if (confirmAction('ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™)')) {
                try {
                    // 1. Storageã‹ã‚‰å‰Šé™¤
                    const storageRef = ref(storage, `recipes/${filename}`);
                    await deleteObject(storageRef);

                    // 2. Firestoreã‹ã‚‰å‰Šé™¤
                    await deleteDoc(doc(db, 'recipes', id));

                    showSuccess('ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadRecipes();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirmAction('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                await signOut(auth);
                window.location.href = 'admin-login.html';
            }
        });

        loadRecipes();
    </script>
</body>

</html>