<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q&Aç·¨é›† - æ¢¶æœ¬ã‚¯ãƒªãƒ‹ãƒƒã‚¯ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="components.css">
</head>

<body class="admin-body">
    <header class="admin-header">
        <div class="admin-header-left">
            <button onclick="location.href='admin-dashboard.html'" class="btn-logout" style="margin-right:1rem;">â†
                æˆ»ã‚‹</button>
            <h1>ğŸ“‹ Q&Aç·¨é›†</h1>
        </div>
        <div class="admin-header-right">
            <button id="importCsvBtn" class="btn-secondary" style="margin-right: 1rem;">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button id="logoutBtn" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <!-- Import Modal (Simple implementation) -->
    <div id="importModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>CSVãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
            <p><code>qa-data.csv</code> ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><small style="color:red;">â€»æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦å‰Šé™¤ï¼ˆä¸Šæ›¸ãï¼‰ã•ã‚Œã¾ã™ã€‚</small></p>
            <div class="form-group">
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <div id="importStatus" style="margin-bottom:1rem; font-size:0.9rem;"></div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button id="closeModalBtn" class="btn-secondary">é–‰ã˜ã‚‹</button>
                <button id="executeImportBtn" class="btn-primary" disabled>å®Ÿè¡Œã™ã‚‹</button>
            </div>
        </div>
    </div>


    <main class="admin-container">
        <section class="editor-section">
            <h2 id="formTitle">æ–°è¦Q&Aç™»éŒ²</h2>
            <form id="qaForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="category" required>
                        <option value="ã‚·ãƒ£ãƒ³ãƒˆ">ã‚·ãƒ£ãƒ³ãƒˆ</option>
                        <option value="æ „é¤Š">æ „é¤Š</option>
                        <option value="é‹å‹•">é‹å‹•</option>
                        <option value="ç½å®³">ç½å®³</option>
                        <option value="ãƒ•ãƒƒãƒˆã‚±ã‚¢">ãƒ•ãƒƒãƒˆã‚±ã‚¢</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="question">è³ªå•</label>
                    <textarea id="question" required placeholder="è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>
                <div class="form-group">
                    <label for="answer">å›ç­”</label>
                    <textarea id="answer" required placeholder="å›ç­”å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" id="submitBtn" class="btn-primary">ç™»éŒ²ã™ã‚‹</button>
                    <button type="button" id="cancelBtn" class="btn-secondary" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </section>

        <section class="editor-section">
            <h2>ç™»éŒ²æ¸ˆã¿Q&Aä¸€è¦§</h2>
            <div class="form-group">
                <input type="text" id="searchInput" placeholder="è³ªå•ãƒ»å›ç­”ã‹ã‚‰æ¤œç´¢...">
            </div>
            <div id="qaList">
                <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { requireAuth } from './js/admin/auth-guard.js';
        import { requirePermission } from './js/admin/permission-check.js';
        import { showSuccess, confirmAction } from './js/admin/ui-helper.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig } from './js/firebase-config.js';
        import { parseQADataCSV } from './js/admin/csv-parser.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // èªè¨¼&æ¨©é™ãƒã‚§ãƒƒã‚¯
        const user = await requireAuth();
        await requirePermission('qa');

        const qaForm = document.getElementById('qaForm');
        const qaList = document.getElementById('qaList');
        const searchInput = document.getElementById('searchInput');
        const editIdInput = document.getElementById('editId');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // CSV Import elements
        const importCsvBtn = document.getElementById('importCsvBtn');
        const importModal = document.getElementById('importModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const executeImportBtn = document.getElementById('executeImportBtn');
        const csvFileInput = document.getElementById('csvFile');
        const importStatus = document.getElementById('importStatus');


        let allQaData = [];

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadQaData() {
            try {
                const q = query(collection(db, 'qa'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                allQaData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQaList(allQaData);
            } catch (error) {
                console.error('Error loading QA:', error);
                qaList.innerHTML = '<p class="error-message">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        function renderQaList(data) {
            if (data.length === 0) {
                qaList.innerHTML = '<p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹Q&Aã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            qaList.innerHTML = data.map(item => `
        <div class="qa-list-item">
          <div>
            <span class="qa-category-badge badge-${item.category}">${item.category}</span>
          </div>
          <div class="qa-question">Q. ${item.question}</div>
          <div class="qa-answer">${item.answer}</div>
          <div class="qa-meta">
            ä½œæˆæ—¥: ${item.createdAt?.toDate ? item.createdAt.toDate().toLocaleString() : '---'} | 
            æ›´æ–°æ—¥: ${item.updatedAt?.toDate ? item.updatedAt.toDate().toLocaleString() : '---'}
          </div>
          <div class="user-actions">
            <button class="btn-primary" onclick="window.editQa('${item.id}')" style="padding: 0.4rem 1rem; font-size: 0.8rem;">ç·¨é›†</button>
            <button class="btn-danger" onclick="window.deleteQa('${item.id}')" style="padding: 0.4rem 1rem; font-size: 0.8rem;">å‰Šé™¤</button>
          </div>
        </div>
      `).join('');
        }

        // æ¤œç´¢æ©Ÿèƒ½
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = allQaData.filter(item =>
                item.question.toLowerCase().includes(keyword) ||
                item.answer.toLowerCase().includes(keyword) ||
                item.category.includes(keyword)
            );
            renderQaList(filtered);
        });

        // ç™»éŒ²ãƒ»æ›´æ–°å‡¦ç†
        qaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editIdInput.value;
            const data = {
                category: document.getElementById('category').value,
                question: document.getElementById('question').value,
                answer: document.getElementById('answer').value,
                updatedAt: Timestamp.now(),
                updatedBy: user.uid
            };

            try {
                if (id) {
                    // æ›´æ–°
                    await updateDoc(doc(db, 'qa', id), data);
                    showSuccess('Q&Aã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    // æ–°è¦ç™»éŒ²
                    data.createdAt = Timestamp.now();
                    data.createdBy = user.uid;
                    await addDoc(collection(db, 'qa'), data);
                    showSuccess('Q&Aã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                }
                resetForm();
                loadQaData();
            } catch (error) {
                console.error('Save error:', error);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        });

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        window.editQa = (id) => {
            const item = allQaData.find(q => q.id === id);
            if (!item) return;

            editIdInput.value = item.id;
            document.getElementById('category').value = item.category;
            document.getElementById('question').value = item.question;
            document.getElementById('answer').value = item.answer;

            formTitle.textContent = 'Q&Aç·¨é›†';
            submitBtn.textContent = 'æ›´æ–°ã™ã‚‹';
            cancelBtn.style.display = 'inline-block';
            window.scrollTo(0, 0);
        };

        // å‰Šé™¤å‡¦ç†
        window.deleteQa = async (id) => {
            if (confirmAction('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await deleteDoc(doc(db, 'qa', id));
                    showSuccess('å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadQaData();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        };

        function resetForm() {
            editIdInput.value = '';
            qaForm.reset();
            formTitle.textContent = 'æ–°è¦Q&Aç™»éŒ²';
            submitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
            cancelBtn.style.display = 'none';
        }

        cancelBtn.addEventListener('click', resetForm);

        // --- CSV Import Logic ---
        importCsvBtn.addEventListener('click', () => {
            importModal.style.display = 'flex';
            importStatus.textContent = '';
            csvFileInput.value = '';
            executeImportBtn.disabled = true;
        });

        closeModalBtn.addEventListener('click', () => {
            importModal.style.display = 'none';
        });

        csvFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                executeImportBtn.disabled = false;
                importStatus.textContent = `é¸æŠä¸­: ${e.target.files[0].name}`;
            }
        });

        executeImportBtn.addEventListener('click', async () => {
            const file = csvFileInput.files[0];
            if (!file) return;

            if (!confirm('æ—¢å­˜ã®Q&Aãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            executeImportBtn.disabled = true;
            importStatus.textContent = 'åˆæœŸåŒ–ä¸­...';

            try {
                // 1. Existing data deletion
                const snapshot = await getDocs(collection(db, 'qa'));
                const deletePromises = snapshot.docs.map(d => deleteDoc(doc(db, 'qa', d.id)));
                await Promise.all(deletePromises);

                importStatus.textContent = 'è§£æ & ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...';

                // 2. Read file (Trying Shift-JIS as default for Japanese CSV)
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const data = parseQADataCSV(text);

                    if (data.length === 0) {
                        importStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: CSVã‹ã‚‰æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                        executeImportBtn.disabled = false;
                        return;
                    }

                    // 3. Batched upload (Simple loop for now)
                    let count = 0;
                    for (const item of data) {
                        await addDoc(collection(db, 'qa'), {
                            ...item,
                            createdAt: Timestamp.now(),
                            updatedAt: Timestamp.now(),
                            createdBy: user.uid,
                            updatedBy: user.uid
                        });
                        count++;
                        importStatus.textContent = `ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­... (${count} / ${data.length})`;
                    }

                    importStatus.style.color = 'green';
                    importStatus.textContent = `æˆåŠŸ! ${count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`;
                    loadQaData();
                    setTimeout(() => importModal.style.display = 'none', 1500);
                };

                reader.readAsText(file, 'Shift_JIS'); // Common encoding for Japanese Excel CSV

            } catch (error) {
                console.error('Import error:', error);
                importStatus.style.color = 'red';
                importStatus.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
                executeImportBtn.disabled = false;
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirmAction('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                await signOut(auth);
                window.location.href = 'admin-login.html';
            }
        });

        // åˆæœŸèª­ã¿è¾¼ã¿
        loadQaData();
    </script>
</body>

</html>