<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - æ¢¶æœ¬ã‚¯ãƒªãƒ‹ãƒƒã‚¯ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <script>
        // file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã®å®Ÿè¡Œã‚’ãƒã‚§ãƒƒã‚¯
        if (window.location.protocol === 'file:') {
            window.addEventListener('DOMContentLoaded', () => {
                const msg = document.getElementById('msg');
                msg.style.color = '#e53e3e';
                msg.style.background = '#fff5f5';
                msg.style.padding = '1rem';
                msg.style.borderRadius = '8px';
                msg.style.border = '1px solid #feb2b2';
                msg.innerHTML = '<strong>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼</strong><br>' +
                    'ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ãã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå‹•ä½œã—ã¾ã›ã‚“ã€‚<br>' +
                    'ä»˜å±ã® <code>start_server.bat</code> ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰<br>' +
                    '<a href="http://localhost:8000/admin-setup.html">http://localhost:8000/admin-setup.html</a><br>' +
                    'ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚';
            });
        }
    </script>
</head>

<body class="auth-page-body">
    <div class="auth-container">
        <div class="auth-header">
            <h1>ğŸ”§ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>
            <p>æœ€åˆã®ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p>
        </div>
        <div id="setupForm" class="form-section">
            <div class="form-group">
                <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="email" required placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰</label>
                <input type="password" id="password" required minlength="8">
            </div>
            <div class="form-group">
                <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                <input type="password" id="confirmPassword" required minlength="8">
            </div>
            <div class="form-group">
                <label for="displayName">è¡¨ç¤ºåï¼ˆä¾‹ï¼šå±±ç”° å¤ªéƒï¼‰</label>
                <input type="text" id="displayName" required>
            </div>
            <div class="form-group">
                <label for="facility">æ‰€å±æ–½è¨­</label>
                <select id="facility" required>
                    <option value="æœ¬é™¢">æœ¬é™¢</option>
                    <option value="ãªã‹ã‚‚ãšåˆ†é™¢">ãªã‹ã‚‚ãšåˆ†é™¢</option>
                    <option value="ä¸‰å›½ãƒ¶ä¸˜åˆ†é™¢">ä¸‰å›½ãƒ¶ä¸˜åˆ†é™¢</option>
                </select>
            </div>
            <div class="btn-container">
                <button type="button" id="submitBtn" class="btn-auth">ç®¡ç†è€…ã‚’ä½œæˆã™ã‚‹</button>
            </div>
            <div id="msg" style="margin-top:1rem; text-align:center;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig } from './js/firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const submitBtn = document.getElementById('submitBtn');
        const msg = document.getElementById('msg');

        // åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
        async function checkInitialized() {
            try {
                const setupDoc = await getDoc(doc(db, 'system', 'setup'));
                if (setupDoc.exists() && setupDoc.data().initialized) {
                    alert('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚');
                    window.location.href = 'admin-login.html';
                }
            } catch (err) {
                console.warn('Initial check failed (normal if rules block read for unauth):', err);
            }
        }
        checkInitialized();

        submitBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const displayName = document.getElementById('displayName').value;
            const facility = document.getElementById('facility').value;

            if (!email || !password || !displayName) {
                alert('å¿…è¦äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            if (password !== confirmPassword) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                return;
            }

            submitBtn.disabled = true;
            msg.textContent = 'ä½œæˆä¸­...';

            try {
                // 1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // 2. Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
                await setDoc(doc(db, 'users', uid), {
                    uid: uid,
                    email: email,
                    displayName: displayName,
                    facility: facility,
                    role: 'admin',
                    permissions: { qa: true, dialysisStatus: true, recipes: true },
                    createdAt: new Date(),
                    updatedAt: new Date()
                });

                // 3. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                await setDoc(doc(db, 'system', 'setup'), {
                    initialized: true,
                    initializedAt: new Date(),
                    initializedBy: uid
                });

                msg.style.color = 'green';
                msg.textContent = 'ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ç§»å‹•ã—ã¾ã™ã€‚';
                setTimeout(() => window.location.href = 'admin-dashboard.html', 2000);
            } catch (error) {
                console.error('Setup error:', error);
                msg.style.color = 'red';

                if (error.code === 'auth/operation-not-allowed') {
                    msg.innerHTML = '<strong>âŒ Firebaseè¨­å®šã‚¨ãƒ©ãƒ¼</strong><br>' +
                        'Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã€ŒEmail/Passwordã€èªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚<br>' +
                        '1. Firebase Consoleã‚’é–‹ã<br>' +
                        '2. Build > Authentication > Sign-in method ã‚’é–‹ã<br>' +
                        '3. ã€ŒEmail/Passwordã€ã‚’æœ‰åŠ¹ï¼ˆEnableï¼‰ã«ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    msg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + error.message;
                }
                submitBtn.disabled = false;
            }
        });
    </script>
</body>

</html>